{% set cover_bg_color = "#ffffff" %}
{% if section.section_type.name == "front_cover" %}
    {% for row in rows %}
        {% for col in row.columns %}
            {% set col_cover_texts = [] %}
            {% for part in col.parts %}
                {% if texts[part] %}
                    {% set _ = col_cover_texts.append(part) %}
                {% endif %}
            {% endfor %}
            {% set cover_bg_color = col.color %}
        {% endfor %}
    {% endfor %}
{% endif %}

<div class="container content mx-auto w-full min-h-screen px-8 py-8 flex items-center justify-center" id="content" style="background-color: {{ cover_bg_color }};">
    <section id="spread-main" role="article" data-section-type="{{ section.section_type.name }}" data-id="{{ section.section_id }}" {% if section.explanation_id %}data-eli5-id="{{ section.explanation_id }}"{% endif %}>
    
    {% if section.section_type.name == "front_cover" %}
        <!-- COVER PAGE LOGIC -->
        {% for row in rows %}
            <div class="flex flex-col lg:flex-row items-start max-w-none w-full" style="gap: 0;">
                {% for col in row.columns %}
                    <!-- Cover page layout: left column image, right column text -->
                    {% set col_images = [] %}
                    {% set col_texts = [] %}
                    {% for part in col.parts %}
                        {% if images[part] %}
                            {% set _ = col_images.append(part) %}
                        {% elif texts[part] %}
                            {% set _ = col_texts.append(part) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if col_images|length > 0 %}
                        <!-- Left column with cover image -->
                        <div class="basis-1/2 p-4 flex flex-col justify-start items-center" style="color: {{ col.color }};">
                            {% for part in col_images %}
                            <img class="mb-8 w-full rounded-lg" data-id="{{ part }}" style="height: 100vh; object-fit: contain;"></img>
                            {% endfor %}
                        </div>
                    {% elif col_texts|length > 0 %}
                        <!-- Right column with cover text -->
                        <div class="basis-1/2 p-4 flex flex-col justify-start items-center" style="color: {{ col.color }};">
                            {% if col_texts|length > 0 %}
                            <!-- Group consecutive text parts for accessibility -->
                            <p class="mb-6 flex flex-col justify-start items-start w-full max-w-4xl">
                                {% for text_part in col_texts %}
                                {% if loop.first %}
                                <span class="block text-2xl font-bold leading-tight text-left" data-id="{{ text_part }}">{{ texts[text_part] }}</span>
                                {% else %}
                                <span class="block text-lg leading-relaxed text-left" data-id="{{ text_part }}">{{ texts[text_part] }}</span>
                                {% endif %}
                                {% endfor %}
                            </p>
                            {% endif %}
                        </div>
                    {% else %}
                        <!-- Empty column -->
                        <div class="basis-1/2 p-4" style="color: {{ col.color }};"></div>
                    {% endif %}
                {% endfor %}
            </div>
        {% endfor %}
    {% else %}
        <!-- SPREAD AND SINGLE COLUMN LOGIC - collect all content first -->
        {% set all_images = [] %}
        {% set all_texts = [] %}
        {% set total_columns = 0 %}
        {% for row in rows %}
            {% set total_columns = total_columns + row.columns|length %}
            {% for col in row.columns %}
                {% for part in col.parts %}
                    {% if images[part] %}
                        {% set _ = all_images.append(part) %}
                    {% elif texts[part] %}
                        {% set _ = all_texts.append(part) %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% endfor %}
        
        {% if total_columns <= 2 %}
            <!-- SPREAD LAYOUT: Two columns total across all rows -->
            <div class="flex flex-col lg:flex-row items-start max-w-none w-full" style="gap: 0;">
                <!-- Left column: ALL TEXT -->
                <div class="basis-1/2 p-4 flex flex-col justify-start items-center" style="color: #000000;">
                    {% if all_texts|length > 0 %}
                    <!-- Group consecutive text parts for accessibility using GROUP_BREAK markers -->
                    {% set current_group = [] %}
                    {% for text_part in all_texts %}
                        {% if text_part == "GROUP_BREAK" %}
                            {% if current_group|length > 0 %}
                                <p class="mb-6 flex flex-col justify-start items-start w-full max-w-4xl">
                                    {% for part in current_group %}
                                    {% if loop.first %}
                                    <span class="block text-2xl font-bold leading-tight text-left" data-id="{{ part }}">{{ texts[part] }}</span>
                                    {% else %}
                                    <span class="block text-lg leading-relaxed text-left" data-id="{{ part }}">{{ texts[part] }}</span>
                                    {% endif %}
                                    {% endfor %}
                                </p>
                                {% set current_group = [] %}
                            {% endif %}
                        {% else %}
                            {% set _ = current_group.append(text_part) %}
                        {% endif %}
                    {% endfor %}
                    <!-- Render final group if exists -->
                    {% if current_group|length > 0 %}
                        <p class="mb-6 flex flex-col justify-start items-start w-full max-w-4xl">
                            {% for part in current_group %}
                            {% if loop.first %}
                            <span class="block text-2xl font-bold leading-tight text-left" data-id="{{ part }}">{{ texts[part] }}</span>
                            {% else %}
                            <span class="block text-lg leading-relaxed text-left" data-id="{{ part }}">{{ texts[part] }}</span>
                            {% endif %}
                            {% endfor %}
                        </p>
                    {% endif %}
                    {% endif %}
                </div>
                
                <!-- Right column: ALL IMAGES -->
                <div class="basis-1/2 p-4 flex flex-col justify-start items-center" style="color: #000000;">
                    {% for part in all_images %}
                    <img class="mb-8 w-full rounded-lg" data-id="{{ part }}" src="images/{{ part }}.png" style="height: 100vh; object-fit: contain;"/>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <!-- SINGLE COLUMN LAYOUT: Process each row individually -->
            {% for row in rows %}
                <div class="flex flex-col lg:flex-row items-start max-w-none w-full" style="gap: 0;">
                    {% for col in row.columns %}
                        <!-- Single column layout for non-cover pages -->
                        {% set col_images = [] %}
                        {% set col_texts = [] %}
                        {% for part in col.parts %}
                            {% if images[part] %}
                                {% set _ = col_images.append(part) %}
                            {% elif texts[part] %}
                                {% set _ = col_texts.append(part) %}
                            {% endif %}
                        {% endfor %}
                        
                        <!-- Decide overlay based on content: if we have both text and images in same column -->
                        {% set should_overlay = col_images|length > 0 and col_texts|length > 0 %}
                        
                        {% if should_overlay %}
                            <!-- Single column with overlay layout -->
                            <div class="basis-full p-4 flex flex-col justify-start items-center relative">
                                <img class="w-full rounded-lg" data-id="{{ col_images[0] }}" style="height: 100vh; object-fit: contain;"/>
                                <div class="absolute inset-0 flex flex-col justify-center items-center p-8" style="color: {{ col.color }};">
                                    {% if col_texts|length > 0 %}
                                    <!-- Group consecutive text parts for accessibility using GROUP_BREAK markers -->
                                    {% set current_group = [] %}
                                    {% for text_part in col_texts %}
                                        {% if text_part == "GROUP_BREAK" %}
                                            {% if current_group|length > 0 %}
                                                <p class="mb-6 flex flex-col justify-start items-start w-full max-w-4xl">
                                                    {% for part in current_group %}
                                                    {% if loop.first %}
                                                    <span class="block text-2xl font-bold leading-tight text-left drop-shadow-lg" data-id="{{ part }}">{{ texts[part] }}</span>
                                                    {% else %}
                                                    <span class="block text-lg leading-relaxed text-left drop-shadow-lg" data-id="{{ part }}">{{ texts[part] }}</span>
                                                    {% endif %}
                                                    {% endfor %}
                                                </p>
                                                {% set current_group = [] %}
                                            {% endif %}
                                        {% else %}
                                            {% set _ = current_group.append(text_part) %}
                                        {% endif %}
                                    {% endfor %}
                                    <!-- Render final group if exists -->
                                    {% if current_group|length > 0 %}
                                        <p class="mb-6 flex flex-col justify-start items-start w-full max-w-4xl">
                                            {% for part in current_group %}
                                            {% if loop.first %}
                                            <span class="block text-2xl font-bold leading-tight text-left drop-shadow-lg" data-id="{{ part }}">{{ texts[part] }}</span>
                                            {% else %}
                                            <span class="block text-lg leading-relaxed text-left drop-shadow-lg" data-id="{{ part }}">{{ texts[part] }}</span>
                                            {% endif %}
                                            {% endfor %}
                                        </p>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <!-- Standard single column layout -->
                            <div class="basis-full p-4 flex flex-col justify-start items-center">
                                {% if col_texts|length > 0 %}
                                <!-- Group consecutive text parts for accessibility using GROUP_BREAK markers -->
                                {% set current_group = [] %}
                                {% for text_part in col_texts %}
                                    {% if text_part == "GROUP_BREAK" %}
                                        {% if current_group|length > 0 %}
                                            <p class="mb-6 flex flex-col justify-start items-start w-full max-w-4xl">
                                                {% for part in current_group %}
                                                {% set text_alignment = "text-center" if section.section_type.name == "credits" else "text-left" %}
                                                {% if loop.first %}
                                                <span class="block text-2xl font-bold leading-tight {{ text_alignment }}" data-id="{{ part }}">{{ texts[part] }}</span>
                                                {% else %}
                                                <span class="block text-lg leading-relaxed {{ text_alignment }}" data-id="{{ part }}">{{ texts[part] }}</span>
                                                {% endif %}
                                                {% endfor %}
                                            </p>
                                            {% set current_group = [] %}
                                        {% endif %}
                                    {% else %}
                                        {% set _ = current_group.append(text_part) %}
                                    {% endif %}
                                {% endfor %}
                                <!-- Render final group if exists -->
                                {% if current_group|length > 0 %}
                                    <p class="mb-6 flex flex-col justify-start items-start w-full max-w-4xl">
                                        {% for part in current_group %}
                                        {% set text_alignment = "text-center" if section.section_type.name == "credits" else "text-left" %}
                                        {% if loop.first %}
                                        <span class="block text-2xl font-bold leading-tight {{ text_alignment }}" data-id="{{ part }}">{{ texts[part] }}</span>
                                        {% else %}
                                        <span class="block text-lg leading-relaxed {{ text_alignment }}" data-id="{{ part }}">{{ texts[part] }}</span>
                                        {% endif %}
                                        {% endfor %}
                                    </p>
                                {% endif %}
                                {% endif %}
                                
                                {% for part in col_images %}
                                <img class="mb-8 w-full rounded-lg" data-id="{{ part }}" style="height: 100vh; object-fit: contain;"></img>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endfor %}
        {% endif %}
    {% endif %}
    </section>
</div>